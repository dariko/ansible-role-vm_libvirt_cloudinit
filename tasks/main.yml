-   include_tasks: deprovision.yml
    when: vm_rebuild or vm_deprovision

-   include_tasks: provision.yml
    when: not vm_deprovision

-   name: start vm
    delegate_to: "{{vm_host}}"
    virt:
        name: "{{vm_hostname}}"
        state: running
        autostart: true
    when: vm_start
    register: out_vm_start
    retries: 2
    until: not out_vm_start|failed
    delay: 2

-   name: set fact vm_started
    set_fact:
        vm_started: "{{out_vm_start.changed if out_vm_start is defined else False}}"

-   name: autostart vm
    delegate_to: "{{vm_host}}"
    virt:
        name: "{{vm_hostname}}"
        autostart: true
        command: status
    when: vm_start

-   name: wait for tcp22
    listen: bootstrap vm
    delegate_to: "{{vm_host}}"
    wait_for:
        host: "{{vm_networks[0].address|ipaddr('address')}}"
        port: 22
    when: vm_wait_for_tcp22

-   name: sleep
    pause:
        seconds: "{{vm_start_sleep}}"
    when: vm_started
